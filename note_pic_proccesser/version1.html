<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é»‘æ¿ç¬”è®°å›¾ç‰‡å¤„ç†å™¨-æ— å¹³æ»‘ç²¾ç¡®ç‰ˆ</title>
<style>
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: 20px;
color: #333;
}
.container {
    max-width: 1000px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

h1 {
    text-align: center;
    color: #4a5568;
    margin-bottom: 10px;
    font-size: 28px;
}

.subtitle {
    text-align: center;
    color: #718096;
    margin-bottom: 30px;
    font-size: 16px;
}

.upload-area {
    border: 3px dashed #cbd5e0;
    border-radius: 15px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
    margin-bottom: 30px;
}

.upload-area:hover, .upload-area.dragover {
    border-color: #667eea;
    background: #edf2f7;
}

.upload-icon {
    font-size: 60px;
    color: #a0aec0;
    margin-bottom: 20px;
}

.upload-text {
    font-size: 18px;
    color: #4a5568;
    margin-bottom: 10px;
}

.upload-hint {
    color: #a0aec0;
    font-size: 14px;
}

.settings {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
}

.settings h2 {
    color: #4a5568;
    margin-bottom: 20px;
    font-size: 20px;
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.setting-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.setting-item label {
    font-weight: 600;
    color: #4a5568;
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.slider-value {
    min-width: 40px;
    font-weight: 600;
    color: #667eea;
}

input[type="range"] {
    flex: 1;
    height: 8px;
    border-radius: 4px;
    background: #e2e8f0;
    outline: none;
    -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #667eea;
    cursor: pointer;
}

.color-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
}

.color-box {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.color-sample {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.control-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

button {
    padding: 14px 28px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.process-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    min-width: 180px;
}

.process-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

.download-btn {
    background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    color: white;
    min-width: 180px;
}

.download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(76, 175, 80, 0.4);
}

.reset-btn {
    background: #e2e8f0;
    color: #4a5568;
}

.reset-btn:hover {
    background: #cbd5e0;
}

.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 1000;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #e2e8f0;
    border-top: 5px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.preview-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.preview-item {
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    background: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.preview-image {
    width: 100%;
    height: 250px;
    object-fit: contain;
    background: #f8f9fa;
    border-bottom: 1px solid #e2e8f0;
}

.preview-info {
    padding: 15px;
}

.preview-name {
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 5px;
    word-break: break-all;
}

.preview-size {
    color: #a0aec0;
    font-size: 14px;
}

.preview-before-after {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.preview-label {
    text-align: center;
    padding: 5px;
    font-size: 12px;
    font-weight: 600;
    color: #718096;
}

.stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #667eea;
}

.stat-label {
    font-size: 14px;
    color: #718096;
}

.instructions {
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    border-radius: 12px;
    padding: 20px;
    margin-top: 30px;
}

.instructions h3 {
    color: white;
    margin-bottom: 10px;
}

.instructions ul {
    padding-left: 20px;
    color: white;
}

.instructions li {
    margin-bottom: 5px;
}

@media (max-width: 768px) {
    .container {
        padding: 20px 15px;
    }
    
    .preview-container {
        grid-template-columns: 1fr;
    }
    
    .control-buttons {
        flex-direction: column;
    }
    
    button {
        width: 100%;
        justify-content: center;
    }
}
</style>
</head>
<body>
<div class="container">ğŸ“±é»‘æ¿ç¬”è®°å›¾ç‰‡å¤„ç†å™¨-æ— å¹³æ»‘ç²¾ç¡®ç‰ˆ
å°†é»‘æ¿èƒŒæ™¯(#212121)è½¬æ¢ä¸ºç™½è‰²(#ffffff)ï¼Œç™½è‰²æ–‡å­—(#ffffff)è½¬æ¢ä¸ºé»‘è‰²(#000000)ï¼Œå…¶ä»–é¢œè‰²ä¿æŒä¸å˜
<div class="stats">

    <div class="stat-item">
        <div class="stat-value" id="fileCount">0</div>
        <div class="stat-label">å·²é€‰æ‹©å›¾ç‰‡</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="processedCount">0</div>
        <div class="stat-label">å·²å¤„ç†å›¾ç‰‡</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" id="estimatedInk">-</div>
        <div class="stat-label">é¢„è®¡èŠ‚çœå¢¨æ°´</div>
    </div>
</div>

<div class="upload-area" id="uploadArea">
    <div class="upload-icon">ğŸ“</div>
    <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
    <div class="upload-hint">æ”¯æŒæ‰¹é‡ä¸Šä¼ ï¼Œæœ€å¤š50å¼ å›¾ç‰‡</div>
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
</div>

<div class="settings">
    <h2>âš™ï¸ å¤„ç†è®¾ç½®</h2>
    <div class="settings-grid">
        <div class="setting-item">
            <label>èƒŒæ™¯è‰²è¯†åˆ«å®¹å·®</label>
            <div class="slider-container">
                <input type="range" id="tolerance" min="0" max="50" value="10">
                <span class="slider-value" id="toleranceValue">10</span>
            </div>
            <small>æ§åˆ¶è¯†åˆ«#212121èƒŒæ™¯è‰²çš„å®½æ¾ç¨‹åº¦ï¼Œå€¼è¶Šå¤§åŒ…å«çš„é¢œè‰²èŒƒå›´è¶Šå¹¿</small>
        </div>
        
        <div class="setting-item">
            <label>é¢œè‰²è½¬æ¢è§„åˆ™</label>
            <div class="color-info">
                <div class="color-box">
                    <div class="color-sample" style="background-color: #212121;"></div>
                    <div>é»‘æ¿èƒŒæ™¯è‰²(#212121) â†’ ç™½è‰²(#ffffff)</div>
                </div>
                <div class="color-box">
                    <div class="color-sample" style="background-color: #ffffff;"></div>
                    <div>ç™½è‰²æ–‡å­—(#ffffff) â†’ é»‘è‰²(#000000)</div>
                </div>
                <div class="color-box">
                    <div class="color-sample" style="background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff);"></div>
                    <div>å…¶ä»–é¢œè‰²ï¼ˆçº¢ã€è“ã€ç»¿ç­‰ï¼‰ â†’ ä¿æŒä¸å˜</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="control-buttons">
    <button class="process-btn" id="processBtn">
        <span>ğŸ”„ å¼€å§‹å¤„ç†å›¾ç‰‡</span>
    </button>
    <button class="download-btn" id="downloadBtn" disabled>
        <span>ğŸ“¥ ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</span>
    </button>
    <button class="reset-btn" id="resetBtn">
        <span>ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡</span>
    </button>
</div>

<div id="previewContainer" class="preview-container">
    <!-- å›¾ç‰‡é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
</div>

<div class="instructions">
    <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</h3>
    <ul>
        <li>1. ç‚¹å‡»ä¸Šæ–¹åŒºåŸŸä¸Šä¼ å›¾ç‰‡ï¼Œæˆ–ç›´æ¥å°†å›¾ç‰‡æ‹–æ‹½åˆ°è¯¥åŒºåŸŸ</li>
        <li>2. è°ƒæ•´èƒŒæ™¯è‰²è¯†åˆ«å®¹å·®ï¼ˆé»˜è®¤10ï¼Œå€¼è¶Šå¤§è¯†åˆ«ä¸ºèƒŒæ™¯è‰²çš„é¢œè‰²èŒƒå›´è¶Šå¹¿ï¼‰</li>
        <li>3. ç‚¹å‡»"å¼€å§‹å¤„ç†å›¾ç‰‡"æŒ‰é’®è¿›è¡Œå¤„ç†</li>
        <li>4. å¤„ç†å®Œæˆåï¼Œç‚¹å‡»"ä¸‹è½½æ‰€æœ‰å›¾ç‰‡"è·å–å¤„ç†åçš„å›¾ç‰‡</li>
        <li>5. æ‰€æœ‰å¤„ç†éƒ½åœ¨æ‚¨çš„æ‰‹æœº/ç”µè„‘æœ¬åœ°å®Œæˆï¼Œå›¾ç‰‡ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨</li>
    </ul>
</div>
</div>

<div class="processing-overlay" id="processingOverlay">
<div class="spinner"></div>
<h2>æ­£åœ¨å¤„ç†å›¾ç‰‡...</h2>
<p id="processingText">è¯·ç¨å€™</p>
</div>

<script>
// å…¨å±€å˜é‡
let originalImages = [];
let processedImages = [];
let isProcessing = false;

// å¸¸é‡å®šä¹‰
const BACKGROUND_COLOR = { r: 33, g: 33, b: 33 };   // #212121
const TEXT_COLOR = { r: 255, g: 255, b: 255 };     // #ffffff

// DOMå…ƒç´ 
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('previewContainer');
const processBtn = document.getElementById('processBtn');
const downloadBtn = document.getElementById('downloadBtn');
const resetBtn = document.getElementById('resetBtn');
const processingOverlay = document.getElementById('processingOverlay');
const processingText = document.getElementById('processingText');
const fileCountElement = document.getElementById('fileCount');
const processedCountElement = document.getElementById('processedCount');
const estimatedInkElement = document.getElementById('estimatedInk');

// æ»‘å—
const toleranceSlider = document.getElementById('tolerance');
const toleranceValue = document.getElementById('toleranceValue');

// äº‹ä»¶ç›‘å¬
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        handleFiles(e.dataTransfer.files);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFiles(e.target.files);
    }
});

processBtn.addEventListener('click', processAllImages);
downloadBtn.addEventListener('click', downloadAllImages);
resetBtn.addEventListener('click', resetAllImages);

// æ»‘å—äº‹ä»¶
toleranceSlider.addEventListener('input', updateSliderValues);

// æ›´æ–°æ»‘å—æ˜¾ç¤ºå€¼
function updateSliderValues() {
    toleranceValue.textContent = toleranceSlider.value;
}

// åˆ¤æ–­é¢œè‰²æ˜¯å¦ä¸ºé»‘æ¿èƒŒæ™¯è‰² (#212121)
function isBackgroundColor(r, g, b, tolerance) {
    const rDiff = Math.abs(r - BACKGROUND_COLOR.r);
    const gDiff = Math.abs(g - BACKGROUND_COLOR.g);
    const bDiff = Math.abs(b - BACKGROUND_COLOR.b);
    
    // å¦‚æœRGBä¸‰ä¸ªé€šé“çš„å·®å¼‚éƒ½åœ¨å®¹å·®èŒƒå›´å†…ï¼Œåˆ™è®¤ä¸ºæ˜¯èƒŒæ™¯è‰²
    return rDiff <= tolerance && gDiff <= tolerance && bDiff <= tolerance;
}

// åˆ¤æ–­é¢œè‰²æ˜¯å¦ä¸ºç™½è‰²æ–‡å­— (#ffffff)
function isTextColor(r, g, b, tolerance) {
    const rDiff = Math.abs(r - TEXT_COLOR.r);
    const gDiff = Math.abs(g - TEXT_COLOR.g);
    const bDiff = Math.abs(b - TEXT_COLOR.b);
    
    // å¦‚æœRGBä¸‰ä¸ªé€šé“çš„å·®å¼‚éƒ½åœ¨å®¹å·®èŒƒå›´å†…ï¼Œåˆ™è®¤ä¸ºæ˜¯æ–‡å­—è‰²
    return rDiff <= tolerance && gDiff <= tolerance && bDiff <= tolerance;
}

// å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
function handleFiles(files) {
    const fileArray = Array.from(files).slice(0, 50); // é™åˆ¶æœ€å¤š50ä¸ªæ–‡ä»¶
    
    fileArray.forEach(file => {
        if (!file.type.startsWith('image/')) {
            alert('è¯·åªä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                originalImages.push({
                    id: Date.now() + Math.random(),
                    file: file,
                    dataUrl: e.target.result,
                    image: img,
                    name: file.name,
                    size: formatFileSize(file.size)
                });
                
                updateFileCount();
                createPreview(img, file.name, file.size, originalImages.length - 1);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
function createPreview(img, name, size, index) {
    const previewItem = document.createElement('div');
    previewItem.className = 'preview-item';
    previewItem.id = `preview-${index}`;
    
    previewItem.innerHTML = `
        <div class="preview-before-after">
            <div>
                <div class="preview-label">å¤„ç†å‰</div>
                <img src="${img.src}" alt="${name}" class="preview-image" crossorigin="anonymous">
            </div>
            <div>
                <div class="preview-label">å¤„ç†å</div>
                <div class="preview-image" style="display:flex;align-items:center;justify-content:center;color:#a0aec0;">
                    ç­‰å¾…å¤„ç†...
                </div>
            </div>
        </div>
        <div class="preview-info">
            <div class="preview-name">${name}</div>
            <div class="preview-size">${formatFileSize(size)}</div>
        </div>
    `;
    
    previewContainer.appendChild(previewItem);
}

// å¤„ç†å•å¼ å›¾ç‰‡
function processImage(img, index) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // è®¾ç½®canvaså°ºå¯¸
        canvas.width = img.width;
        canvas.height = img.height;
        
        // ç»˜åˆ¶å›¾ç‰‡
        ctx.drawImage(img, 0, 0);
        
        // è·å–å›¾ç‰‡æ•°æ®
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // è·å–å®¹å·®å€¼
        const tolerance = parseInt(toleranceSlider.value);
        
        // ç»Ÿè®¡å¤„ç†çš„åƒç´ æ•°é‡
        let backgroundPixels = 0;
        let textPixels = 0;
        let otherPixels = 0;
        
        // å¤„ç†æ¯ä¸ªåƒç´ 
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºé»‘æ¿èƒŒæ™¯è‰² (#212121)
            if (isBackgroundColor(r, g, b, tolerance)) {
                // é»‘æ¿èƒŒæ™¯è‰²è½¬ä¸ºç™½è‰² (#212121 â†’ #ffffff)
                data[i] = 255;     // R
                data[i + 1] = 255; // G
                data[i + 2] = 255; // B
                backgroundPixels++;
            }
            // åˆ¤æ–­æ˜¯å¦ä¸ºç™½è‰²æ–‡å­— (#ffffff)
            else if (isTextColor(r, g, b, tolerance)) {
                // ç™½è‰²æ–‡å­—è½¬ä¸ºé»‘è‰² (#ffffff â†’ #000000)
                data[i] = 0;     // R
                data[i + 1] = 0; // G
                data[i + 2] = 0; // B
                textPixels++;
            }
            else {
                // å…¶ä»–é¢œè‰²ä¿æŒä¸å˜
                otherPixels++;
                // ä¸ä¿®æ”¹ data[i], data[i+1], data[i+2]
            }
            // æ³¨æ„ï¼šdata[i+3] æ˜¯ alpha é€šé“ï¼Œä¿æŒä¸å˜
        }
        
        // å°†å¤„ç†åçš„æ•°æ®æ”¾å›canvas
        ctx.putImageData(imageData, 0, 0);
        
        // è½¬æ¢ä¸ºæ•°æ®URL
        const processedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        
        // æ›´æ–°é¢„è§ˆ
        const previewItem = document.getElementById(`preview-${index}`);
        if (previewItem) {
            const afterImage = previewItem.querySelector('.preview-before-after > div:nth-child(2) .preview-image');
            afterImage.innerHTML = '';
            const imgElement = document.createElement('img');
            imgElement.src = processedDataUrl;
            imgElement.className = 'preview-image';
            afterImage.appendChild(imgElement);
        }
        
        resolve({
            index: index,
            dataUrl: processedDataUrl,
            name: originalImages[index].name,
            stats: {
                backgroundPixels: backgroundPixels,
                textPixels: textPixels,
                otherPixels: otherPixels,
                totalPixels: (canvas.width * canvas.height)
            }
        });
    });
}

// å¤„ç†æ‰€æœ‰å›¾ç‰‡
async function processAllImages() {
    if (originalImages.length === 0) {
        alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
        return;
    }
    
    if (isProcessing) return;
    
    isProcessing = true;
    processedImages = [];
    
    // æ˜¾ç¤ºå¤„ç†ä¸­è¦†ç›–å±‚
    processingOverlay.style.display = 'flex';
    processBtn.disabled = true;
    
    try {
        for (let i = 0; i < originalImages.length; i++) {
            processingText.textContent = `æ­£åœ¨å¤„ç†ç¬¬ ${i + 1} / ${originalImages.length} å¼ å›¾ç‰‡...`;
            
            const result = await processImage(originalImages[i].image, i);
            processedImages.push(result);
            
            // æ›´æ–°å¤„ç†è®¡æ•°
            processedCountElement.textContent = processedImages.length;
            
            // è®©UIæœ‰æœºä¼šæ›´æ–°
            await new Promise(resolve => setTimeout(resolve, 0));
        }
        
        // å¯ç”¨ä¸‹è½½æŒ‰é’®
        downloadBtn.disabled = false;
        
        // è®¡ç®—é¢„è®¡èŠ‚çœçš„å¢¨æ°´
        calculateInkSavings();
        
        alert(`å¤„ç†å®Œæˆï¼å·²æˆåŠŸå¤„ç† ${originalImages.length} å¼ å›¾ç‰‡ã€‚`);
    } catch (error) {
        console.error('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™:', error);
        alert('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚');
    } finally {
        // éšè—å¤„ç†ä¸­è¦†ç›–å±‚
        processingOverlay.style.display = 'none';
        processBtn.disabled = false;
        isProcessing = false;
    }
}

// è®¡ç®—é¢„è®¡èŠ‚çœçš„å¢¨æ°´
function calculateInkSavings() {
    if (originalImages.length === 0) return;
    
    // ç»Ÿè®¡æ‰€æœ‰å›¾ç‰‡çš„èƒŒæ™¯åƒç´ æ€»æ•°
    let totalBackgroundPixels = 0;
    let totalPixels = 0;
    
    processedImages.forEach(img => {
        if (img.stats) {
            totalBackgroundPixels += img.stats.backgroundPixels;
            totalPixels += img.stats.totalPixels;
        }
    });
    
    if (totalPixels > 0) {
        // èƒŒæ™¯åƒç´ æ¯”ä¾‹ï¼ˆè½¬ä¸ºç™½è‰²èŠ‚çœçš„å¢¨æ°´ï¼‰
        const backgroundPercentage = (totalBackgroundPixels / totalPixels) * 100;
        estimatedInkElement.textContent = `${backgroundPercentage.toFixed(1)}%`;
    } else {
        estimatedInkElement.textContent = '-';
    }
}

// ä¸‹è½½æ‰€æœ‰å¤„ç†åçš„å›¾ç‰‡
function downloadAllImages() {
    if (processedImages.length === 0) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡ï¼Œè¯·å…ˆå¤„ç†å›¾ç‰‡ï¼');
        return;
    }
    
    if (processedImages.length === 1) {
        // å•å¼ å›¾ç‰‡ç›´æ¥ä¸‹è½½
        const link = document.createElement('a');
        link.href = processedImages[0].dataUrl;
        link.download = `processed_${processedImages[0].name}`;
        link.click();
    } else {
        // å¤šå¼ å›¾ç‰‡é€ä¸ªä¸‹è½½
        processedImages.forEach((img, index) => {
            const link = document.createElement('a');
            link.href = img.dataUrl;
            link.download = `processed_${img.name}`;
            
            // ä¸ºç¬¬ä¸€ä¸ªé“¾æ¥æ·»åŠ ç‚¹å‡»ï¼Œå…¶ä»–é€šè¿‡å»¶è¿Ÿè§¦å‘
            if (index === 0) {
                link.click();
            } else {
                setTimeout(() => {
                    link.click();
                }, index * 100);
            }
        });
        
        alert(`å¼€å§‹ä¸‹è½½ ${processedImages.length} å¼ å›¾ç‰‡ï¼Œè¯·æ ¹æ®æµè§ˆå™¨æç¤ºå…è®¸ä¸‹è½½å¤šä¸ªæ–‡ä»¶ã€‚`);
    }
}

// é‡ç½®æ‰€æœ‰å›¾ç‰‡
function resetAllImages() {
    if (isProcessing) {
        if (!confirm('æ­£åœ¨å¤„ç†å›¾ç‰‡ï¼Œç¡®å®šè¦å–æ¶ˆå¹¶æ¸…ç©ºå—ï¼Ÿ')) return;
    }
    
    originalImages = [];
    processedImages = [];
    previewContainer.innerHTML = '';
    updateFileCount();
    processedCountElement.textContent = '0';
    estimatedInkElement.textContent = '-';
    downloadBtn.disabled = true;
    fileInput.value = '';
}

// æ›´æ–°æ–‡ä»¶è®¡æ•°
function updateFileCount() {
    fileCountElement.textContent = originalImages.length;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// åˆå§‹åŒ–
updateSliderValues();

// æ·»åŠ é¡µé¢å¸è½½è­¦å‘Š
window.addEventListener('beforeunload', (e) => {
    if (originalImages.length > 0 && !isProcessing) {
        e.preventDefault();
        e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„å›¾ç‰‡å¤„ç†ç»“æœï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
    }
});

// æ·»åŠ é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.metaKey) {
        if (e.key === 'p' || e.key === 'P') {
            e.preventDefault();
            processAllImages();
        } else if (e.key === 'd' || e.key === 'D') {
            e.preventDefault();
            if (!downloadBtn.disabled) {
                downloadAllImages();
            }
        } else if (e.key === 'r' || e.key === 'R') {
            e.preventDefault();
            resetAllImages();
        }
    }
});
</script>